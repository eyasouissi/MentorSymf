{% extends 'front/base.html.twig' %}

{% block title %}Projects{% endblock %}

{% block body %}
<div class="container mt-4">
    <h1 class="mb-4">Projects</h1>
    <a href="{{ path('app_project_front') }}" class="btn btn-primary mb-3">Voir tous les projets</a>

    <!-- Filtres -->
    <div class="row mb-3">
        <div class="col-md-4">
            <input type="text" id="search" class="form-control" placeholder="Search projects...">
        </div>
        <div class="col-md-4">
            <label>Difficulty Level</label>
            <div class="star-rating">
                <span data-value="1" class="star">★</span>
                <span data-value="2" class="star">★</span>
                <span data-value="3" class="star">★</span>
                <span data-value="4" class="star">★</span>
            </div>
        </div>
        <div class="col-md-4">
            <select id="dateFilter" class="form-select">
                <option value="">Sort by Deadline</option>
                <option value="asc">Ascending</option>
                <option value="desc">Descending</option>
            </select>
        </div>
    </div>

    <!-- Tableau des projets -->
    <table class="table table-hover table-striped">
        <thead class="table-dark">
            <tr>
                <th>Title</th>
                <th>Description</th>
                <th>Deadline</th>
                <th>Difficulty</th>
            </tr>
        </thead>
        <tbody id="projectTable">
        {% for project in projects %}
            <tr data-difficulty="{{ project.difficulte }}" data-deadline="{{ project.getDateLimite ? project.getDateLimite|date('Y-m-d') : '' }}">
                <td>{{ project.titre }}</td>
                <td>{{ project.getDescriptionProject() }}</td>
                <td>{{ project.getDateLimite ? project.getDateLimite|date("Y-m-d") : 'No Deadline' }}</td>
                <td>
                    <span class="badge {% if project.difficulte == 1 %}bg-primary{% elseif project.difficulte == 2 %}bg-success{% elseif project.difficulte == 3 %}bg-warning{% else %}bg-danger{% endif %}">
                        {{ project.difficulte }}
                    </span>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <!-- Calendrier -->
    <div id="calendar"></div>
</div>

<!-- Styles pour les étoiles -->
<style>
    .star {
        font-size: 25px;
        cursor: pointer;
        color: gray;
    }
</style>

<!-- Script pour les filtres -->
<script>
    document.getElementById('search').addEventListener('keyup', function () {
        let filter = this.value.toLowerCase();
        document.querySelectorAll('#projectTable tr').forEach(row => {
            let text = row.innerText.toLowerCase();
            row.style.display = text.includes(filter) ? '' : 'none';
        });
    });

    // Filtre par difficulté avec étoiles et couleurs dynamiques
    document.querySelectorAll('.star').forEach(star => {
        star.addEventListener('click', function () {
            let selectedValue = this.getAttribute('data-value');
            let stars = document.querySelectorAll('.star');

            // Réinitialiser les couleurs
            stars.forEach(s => s.style.color = 'gray');

            // Appliquer la bonne couleur
            for (let i = 0; i < selectedValue; i++) {
                stars[i].style.color = ["#64b5f6", "#81c784", "#ffb74d", "#ff7043"][i];
            }

            // Filtrer les projets
            document.querySelectorAll('#projectTable tr').forEach(row => {
                let difficulty = row.getAttribute('data-difficulty');
                row.style.display = (difficulty === selectedValue || selectedValue === "") ? '' : 'none';
            });
        });
    });

    document.getElementById('dateFilter').addEventListener('change', function () {
        let rows = Array.from(document.querySelectorAll('#projectTable tr'));
        let order = this.value;

        if (order) {
            rows.sort((a, b) => {
                let dateA = a.getAttribute('data-deadline') ? new Date(a.getAttribute('data-deadline')) : null;
                let dateB = b.getAttribute('data-deadline') ? new Date(b.getAttribute('data-deadline')) : null;

                if (!dateA) return order === 'asc' ? 1 : -1;
                if (!dateB) return order === 'asc' ? -1 : 1;

                return order === 'asc' ? dateA - dateB : dateB - dateA;
            });

            let tbody = document.getElementById('projectTable');
            rows.forEach(row => tbody.appendChild(row));
        }
    });
</script>

<!-- FullCalendar -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/5.11.3/main.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/5.11.3/main.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        if (!calendarEl) {
            console.error("Élément #calendar introuvable !");
            return;
        }

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'fr', // Affichage en français
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: [
                {% for project in projects %}
                    {% if project.getDateLimite is not null %}
                        {
                            title: "{{ project.titre }}",
                            start: "{{ project.getDateLimite|date('Y-m-d') }}",
                            color: "{% if project.difficulte == 1 %}#64b5f6{% elseif project.difficulte == 2 %}#81c784{% elseif project.difficulte == 3 %}#ffb74d{% else %}#ff7043{% endif %}"
                        }{% if not loop.last %},{% endif %}
                    {% endif %}
                {% endfor %}
            ]
        });

        calendar.render();
    });
</script>

{% endblock %}

{% extends 'back/baseback.html.twig' %}

{% block title %}Projects{% endblock %}

{% block body %}
   <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <!-- Partie à gauche (Groups et Projects) -->
        <div class="navbar-nav">
            <a class="nav-link" href="{{ path('app_group_index') }}">Groups</a>
            <a class="nav-link" href="{{ path('app_project_index') }}">Projects</a>
        </div>

        <!-- Partie à droite (Add Group et Add Project) -->
        <div class="navbar-nav ms-auto"> <!-- ms-auto pour aligner à droite -->
            <a class="nav-link" href="{{ path('app_group_new') }}">Add Group</a>
            <a class="nav-link" href="{{ path('app_project_add') }}">Add Project</a>
        </div>
    </div>
</nav>

    <div class="container mt-4">
        <h1 class="mb-4 text-center fw-bold">Projects Management</h1>

        <!-- Barre de recherche et bouton -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <input type="text" id="search" class="form-control w-25 shadow-sm" placeholder="Search projects...">
            <a href="{{ path('app_project_add') }}" class="btn btn-success btn-lg shadow-sm">
                <i class="fas fa-plus"></i> Create New Project
            </a>
        </div>

        <!-- Filtres sous forme de cartes -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <label for="sortDate" class="form-label fw-bold">Sort by Date</label>
                        <select id="sortDate" class="form-select">
                            <option value="">Default</option>
                            <option value="asc">Oldest First</option>
                            <option value="desc">Newest First</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <label for="filterPdf" class="form-label fw-bold">Filter by PDF</label>
                        <select id="filterPdf" class="form-select">
                            <option value="">All</option>
                            <option value="yes">With PDF</option>
                            <option value="no">Without PDF</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <label for="filterImage" class="form-label fw-bold">Filter by Image</label>
                        <select id="filterImage" class="form-select">
                            <option value="">All</option>
                            <option value="yes">With Image</option>
                            <option value="no">Without Image</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <label class="form-label fw-bold">Filter by Difficulty</label>
                        <div class="star-rating">
                            {% for i in 1..4 %}
                                <span class="star" data-value="{{ i }}" style="cursor: pointer; color: gray;">&#9733;</span>
                            {% endfor %}
                            <span class="star" data-value="" style="cursor: pointer; color: gray;">Clear</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tableau des projets -->
        <div class="table-responsive shadow-sm">
            <table class="table table-hover table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>Id</th>
                        <th>Title</th>
                        <th style="width: 20%;">Description</th> 
                        <th>Creation Date</th>
                        <th>Difficulty</th>
                        <th>PDF</th>
                        <th>Image</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="projectTable">
                {% for project in projects %}
                    <tr data-difficulty="{{ project.difficulte }}" data-date="{{ project.getDateCreationProject|date('Y-m-d') }}" data-pdf="{{ project.getFichierPdf ? 'yes' : 'no' }}" data-image="{{ project.getImage ? 'yes' : 'no' }}">
                        <td>{{ project.id }}</td>
                        <td>{{ project.titre }}</td>
                        <td>{{ project.getDescriptionProject()|striptags|slice(0, 50) ~ '...' }}</td>
                        <td>{{ project.getDateCreationProject|date("Y-m-d") }}</td>
                        <td>
                            <span class="badge {% if project.difficulte == 1 %}bg-success{% elseif project.difficulte == 2 %}bg-warning{% elseif project.difficulte == 3 %}bg-orange{% else %}bg-danger{% endif %}">
                                {{ project.difficulte }}
                            </span>
                        </td>
                        <td>
                            {% if project.getFichierPdf %}
                                <a href="{{ asset('uploads/projet/' ~ project.getFichierPdf()) }}" target="_blank" class="btn btn-sm btn-info">View PDF</a>
                            {% else %}
                                <span class="text-muted">No PDF</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if project.getImage %}
                                <img src="{{ asset('uploads/project_images/' ~ project.getImage()) }}" alt="{{ project.titre }}" width="100" class="img-thumbnail">
                            {% else %}
                                <span class="text-muted">No Image</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ path('app_project_edit', {'id': project.id}) }}" class="btn btn-primary btn-sm">Edit</a>
                            <form action="{{ path('app_project_delete', {'id': project.id}) }}" method="POST" style="display: inline;">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ project.id) }}">
                                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure?')">Delete</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Bouton Clear All -->
        <form action="{{ path('app_project_delete_all') }}" method="POST" class="mt-4">
            <input type="hidden" name="_token" value="{{ csrf_token('delete_all') }}">
            <button type="submit" class="btn btn-outline-danger shadow-sm" onclick="return confirm('Are you sure you want to delete all projects?')">
                <i class="fas fa-trash"></i> Clear All
            </button>
        </form>
    </div>

    <!-- Scripts -->
    <script>
        // Barre de recherche
        document.getElementById('search').addEventListener('keyup', function() {
            let filter = this.value.toLowerCase();
            let rows = document.querySelectorAll('#projectTable tr');
            rows.forEach(row => {
                let text = row.innerText.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        });

        // Tri par date de création
        document.getElementById('sortDate').addEventListener('change', function() {
            let order = this.value;
            let rows = Array.from(document.querySelectorAll('#projectTable tr'));
            rows.sort((a, b) => {
                let dateA = a.getAttribute('data-date');
                let dateB = b.getAttribute('data-date');
                if (order === 'asc') {
                    return dateA.localeCompare(dateB);
                } else if (order === 'desc') {
                    return dateB.localeCompare(dateA);
                } else {
                    return 0;
                }
            });
            let tbody = document.querySelector('#projectTable');
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        });

        // Filtre par PDF
        document.getElementById('filterPdf').addEventListener('change', function() {
            let filter = this.value;
            let rows = document.querySelectorAll('#projectTable tr');
            rows.forEach(row => {
                let hasPdf = row.getAttribute('data-pdf');
                row.style.display = (filter === "" || hasPdf === filter) ? '' : 'none';
            });
        });

        // Filtre par image
        document.getElementById('filterImage').addEventListener('change', function() {
            let filter = this.value;
            let rows = document.querySelectorAll('#projectTable tr');
            rows.forEach(row => {
                let hasImage = row.getAttribute('data-image');
                row.style.display = (filter === "" || hasImage === filter) ? '' : 'none';
            });
        });

        // Filtre par difficulté avec étoiles et couleurs dynamiques
        document.querySelectorAll('.star').forEach(star => {
            star.addEventListener('click', function () {
                let selectedValue = this.getAttribute('data-value');
                let stars = document.querySelectorAll('.star');

                // Réinitialiser les couleurs
                stars.forEach(s => s.style.color = 'gray');

                // Appliquer la bonne couleur
                for (let i = 0; i < selectedValue; i++) {
                    stars[i].style.color = ["#64b5f6", "#81c784", "#ffb74d", "#ff7043"][i];
                }

                // Filtrer les projets
                document.querySelectorAll('#projectTable tr').forEach(row => {
                    let difficulty = row.getAttribute('data-difficulty');
                    row.style.display = (difficulty === selectedValue || selectedValue === "") ? '' : 'none';
                });
            });
        });
    </script>

    <!-- Styles CSS personnalisés -->
    <style>
        .card {
            border-radius: 10px;
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .star-rating {
            font-size: 1.5rem;
        }
        .star {
            transition: color 0.3s;
        }
        .star:hover {
            color: #ffc107 !important;
        }
        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }
        .img-thumbnail {
            border-radius: 10px;
        }
    </style>
{% endblock %}